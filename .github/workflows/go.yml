name: Go

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:

  test:
    # Aumentando o timeout
    timeout-minutes: 10
    runs-on: ubuntu-latest
    env:
      HOST: localhost
      PORT: 5432
      USER: root
      PASSWORD: root
      DBNAME: root
    
    # Removida a matriz vazia (matrix) para evitar confusão de indentação
    # strategy:
    #   matrix:
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    # NOVO PASSO: Configuração do Docker Buildx e Compose
    - name: Setup Docker Buildx and Compose
      uses: docker/setup-buildx-action@v3

    # CORREÇÃO: Usando 'docker compose' (sem hífen)
    - name: Build DB containers
      run: docker compose build

    - name: Start DB services
      run: docker compose up -d

    - name: Test
      # Adicione um pequeno delay (sleep 10) aqui se os testes falharem ocasionalmente.
      run: go test -v main_test.go 
      
  # ---
  build:
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # Simplificando para apenas o 'ubuntu-latest'
        os: ['ubuntu-latest']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Build Go application
      run: go build -v main.go