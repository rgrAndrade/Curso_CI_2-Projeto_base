name: Go

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:

  test:
    # Aumentando o timeout para dar mais tempo para o Docker construir e subir os serviÃ§os.
    timeout-minutes: 10 
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Removendo a matriz (matrix) para go-version, pois ela nÃ£o Ã© necessÃ¡ria para um Ãºnico valor ('1.22')
        # e simplifica o job. Se precisar testar vÃ¡rias versÃµes, reative.
        # go-version: ['1.22'] 
    steps:
    - uses: actions/checkout@v4 # ğŸ”„ ATUALIZADO: Usando a versÃ£o mais recente para o checkout
    
    - name: Set up Go
      # ğŸ”„ ATUALIZADO: Usando a versÃ£o mais recente da action setup-go
      uses: actions/setup-go@v5 
      with:
        # VersÃ£o fixa, simplificando o uso da 'matrix'
        go-version: '1.22' 
        
    # ğŸ†• NOVO PASSO: ConfiguraÃ§Ã£o obrigatÃ³ria para garantir que o Docker e docker-compose funcionem
    - name: Setup Docker Buildx and Compose
      uses: docker/setup-buildx-action@v3

    # ğŸ”§ MUDANÃ‡A: Substituindo docker-compose por 'docker compose' (sem hÃ­fen)
    # Este Ã© o comando padrÃ£o para o plugin Compose nos runners modernos do GitHub.
    - name: Build DB containers
      run: docker compose build # ğŸš€ CORREÃ‡ÃƒO: Usando 'docker compose'

    - name: Start DB services
      run: docker compose up -d # ğŸš€ CORREÃ‡ÃƒO: Usando 'docker compose'

    - name: Test
      # Adicione um pequeno delay (sleep) aqui, se os testes falharem ocasionalmente.
      # Isso dÃ¡ tempo para o banco de dados inicializar completamente.
      run: go test -v main_test.go 
      
  # ---
  # Se o seu build realmente precisa ser executado em versÃµes diferentes do Ubuntu, 
  # mantenha a matriz. Caso contrÃ¡rio, simplifique.
  build:
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # A versÃ£o 'ubuntu-18.04' estÃ¡ obsoleta e sem suporte. 
        # ğŸ—‘ï¸ REMOVIDO: VersÃ£o 18.04. Mantenha apenas o 'ubuntu-latest'.
        os: ['ubuntu-latest']
    steps:
    - uses: actions/checkout@v4 # ğŸ”„ ATUALIZADO: Usando a versÃ£o mais recente para o checkout
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Build Go application
      run: go build -v main.go